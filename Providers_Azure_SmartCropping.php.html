<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Providers/Azure/SmartCropping.php - 10up ClassifAI Hook Docs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: Providers/Azure/SmartCropping.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Provides smart cropping with the Computer Vision service.
 *
 * @since 1.5.0
 * @package Classifai
 */

namespace Classifai\Providers\Azure;

use function Classifai\computer_vision_max_filesize;
use function Classifai\get_largest_acceptable_image_url;

/**
 * SmartCropping class.
 * Connects to Computer Vision's generateThumbnail endpoint to crop images to a region of interest.
 *
 * @see https://docs.microsoft.com/en-us/rest/api/cognitiveservices/computervision/generatethumbnail/
 * @since 1.5.0
 */
class SmartCropping {
	/**
	 * The Computer Vision API path to the thumbnail generation service.
	 *
	 * @since 1.5.0
	 *
	 * @var string
	 */
	const API_PATH = 'vision/v3.1/generateThumbnail/';

	/**
	 * ComputerVisition settings.
	 *
	 * @since 1.5.0
	 *
	 * @var array
	 */
	private $settings;

	/**
	 * WP_Filesystem_Base instance.
	 *
	 * @since 1.5.0
	 *
	 * @var WP_Filesystem_Base
	 */
	private $wp_filesystem;

	/**
	 * SmartCropping constructor
	 *
	 * @since 1.5.0
	 *
	 * @param array $settings Computer Vision settings.
	 */
	public function __construct( array $settings ) {
		$this->settings = $settings;
	}

	/**
	 * Provides the global WP_Filesystem_Base class instance.
	 *
	 * @since 1.5.0
	 *
	 * @return WP_Filesystem_Base
	 */
	public function get_wp_filesystem() {
		global $wp_filesystem;

		if ( is_null( $this->wp_filesystem ) ) {
			if ( ! $wp_filesystem ) {
				WP_Filesystem(); // Initiates the global.
			}

			$this->wp_filesystem = $wp_filesystem;
		}

		/**
		 * Filters the filesystem class instance used to save image files.
		 *
		 * @since 1.5.0
		 * @hook classifai_smart_crop_wp_filesystem
		 *
		 * @param {WP_Filesystem_Base} $this->wp_filesystem Filesystem class for saving images.
		 *
		 * @return {WP_Filesystem_Base} Filtered Filesystem class.
		 */
		return apply_filters( 'classifai_smart_crop_wp_filesystem', $this->wp_filesystem );
	}

	/**
	 * Provides the maximum allowable width or height in pixels accepted by the generateThumbnail endpoint.
	 *
	 * @since 1.5.0
	 * @see https://docs.microsoft.com/en-us/rest/api/cognitiveservices/computervision/generatethumbnail/generatethumbnail#uri-parameters
	 *
	 * @return int
	 */
	public function get_max_pixel_dimension() {
		/**
		 * Filters the maximum allowable width or height of an image to be cropped. Default 1024.
		 *
		 * @since 1.5.0
		 * @hook classifai_smart_crop_max_pixel_dimension
		 *
		 * @param {int} $max The max width/height in pixels. Default 1024.
		 *
		 * @return {int} Filtered max dimension in pixels.
		 */
		return apply_filters( 'classifai_smart_crop_max_pixel_dimension', 1024 );
	}

	/**
	 * Returns whether smart cropping should be applied to images of a given size.
	 *
	 * @since 1.5.0
	 *
	 * @param string $size An image size.
	 * @return boolean
	 */
	public function should_crop( $size ) {
		if ( 'thumbnail' === $size ) {
			return boolval( get_option( 'thumbnail_crop', false ) );
		}

		$image_sizes = wp_get_additional_image_sizes();
		if ( ! isset( $image_sizes[ $size ] )
			|| ! isset( $image_sizes[ $size ]['height'] )
			|| ! isset( $image_sizes[ $size ]['width'] ) ) {
			return false;
		}

		// If positions are specified in the add_image_size crop argument, as indicated by the crop field being an
		// array, then that should take priority and smart cropping should not run.
		if ( is_array( $image_sizes[ $size ]['crop'] ) ) {
			$return = false;
		} else {
			$return = boolval( $image_sizes[ $size ]['crop'] );
		}

		$max_pixels = $this->get_max_pixel_dimension();
		if ( $max_pixels &lt; $image_sizes[ $size ]['height'] || $max_pixels &lt; $image_sizes[ $size ]['width'] ) {
			$return = false;
		}

		/**
		 * Filters whether to smart crop images of a given size.
		 *
		 * @since 1.5.0
		 * @hook classifai_should_crop_size
		 *
		 * @param {bool}   $return Whether non-position-based cropping was opted into when registering the image size.
		 * @param {string} $size   The image size.
		 *
		 * @return {bool} Whether this image size should be smart cropped.
		 */
		return apply_filters( 'classifai_should_crop_size', $return, $size );
	}

	/**
	 * Filters attachment meta data
	 *
	 * @since 1.5.0
	 *
	 * @param array $metadata Image attachment metadata.
	 * @param int   $attachment_id Attachment ID.
	 * @return array Filtered image attachment metadata.
	 */
	public function generate_attachment_metadata( $metadata, $attachment_id ) {
		if ( ! isset( $metadata['sizes'] ) || empty( $metadata['sizes'] ) ) {
			return $metadata;
		}

		foreach ( $metadata['sizes'] as $size => $size_data ) {
			if ( ! $this->should_crop( $size ) ) {
				continue;
			}

			$data = [
				'width'  => $size_data['width'],
				'height' => $size_data['height'],
			];

			$better_thumb_filename = $this->get_cropped_thumbnail( $attachment_id, $data );

			if ( ! is_wp_error( $better_thumb_filename ) ) {
				$metadata['sizes'][ $size ]['file'] = basename( $better_thumb_filename );
			}
		}

		return $metadata;
	}

	/**
	 * Gets a cropped thumbnail from the Azure API.
	 *
	 * @since 1.5.0.
	 *
	 * @param int   $attachment_id Attachment ID.
	 * @param array $size_data Attachment metadata size data.
	 * @return string|\WP_Error The thumbnail file name or WP_Error on failure.
	 */
	public function get_cropped_thumbnail( $attachment_id, $size_data ) {
		/**
		 * Filters the image URL to send to Computer Vision for smart cropping. A non-null value will override default
		 * plugin behavior.
		 *
		 * @since 1.5.0
		 * @hook classifai_smart_cropping_source_url
		 *
		 * @param {null|string} url            `null` to use default plugin behavior; `string` to override.
		 * @param {int}         $attachment_id The attachment image ID.
		 *
		 * @return {null|string} URL to be sent to Computer Vision for smart cropping.
		 */
		$url = apply_filters( 'classifai_smart_cropping_source_url', null, $attachment_id );

		if ( empty( $url ) ) {
			$url = get_largest_acceptable_image_url(
				get_attached_file( $attachment_id ),
				wp_get_attachment_url( $attachment_id, 'full' ),
				$size_data,
				computer_vision_max_filesize()
			);
		}

		if ( empty( $url ) || empty( $size_data ) || ! is_array( $size_data ) ) {
			return new \WP_Error( 'classifai_smart_cropping_invalid_args', 'Invalid arguments for API request.' );
		}

		$data = [
			'width'  => $size_data['width'],
			'height' => $size_data['height'],
			'url'    => $url,
		];

		$new_thumb_image = $this->request_cropped_thumbnail( $data );
		set_transient( 'classifai_azure_computer_vision_smart_cropping_latest_response', $new_thumb_image, DAY_IN_SECONDS * 30 );

		if ( is_wp_error( $new_thumb_image ) ) {
			return $new_thumb_image;
		}

		if ( empty( $new_thumb_image ) ) {
			return new \WP_Error( 'classifai_smart_cropping_empty_image', 'Empty cropped image.' );
		}

		$attached_file       = get_attached_file( $attachment_id );
		$file_path_info      = pathinfo( $attached_file );
		$new_thumb_file_name = str_replace(
			$file_path_info['filename'],
			sprintf(
				'%s-%dx%d',
				$file_path_info['filename'],
				$size_data['width'],
				$size_data['height']
			),
			$attached_file
		);

		/**
		 * Filters the file name of the smart-cropped image. By default, the filename mirrors what is generated by
		 * core -- e.g., my-thumb-150x150.jpg -- so will override the core-generated image. Apply this filter to keep
		 * the original file in the file system.
		 *
		 * @since 1.5.0
		 * @hook classifai_smart_cropping_thumb_file_name
		 *
		 * @param {string} Default file name.
		 * @param {int}    The ID of the attachment being processed.
		 * @param {array}  Width and height data for the image.
		 *
		 * @return {string} Filtered file name.
		 */
		$new_thumb_file_name = apply_filters(
			'classifai_smart_cropping_thumb_file_name',
			$new_thumb_file_name,
			$attachment_id,
			$size_data
		);

		$filesystem = $this->get_wp_filesystem();
		if ( $filesystem &amp;&amp; $filesystem->put_contents( $new_thumb_file_name, $new_thumb_image ) ) {
			return $new_thumb_file_name;
		}

		return new \WP_Error( 'classifai_smart_cropping_filesystem_error', 'Filesystem error. Can not write cropped thumbnail file.' );
	}

	/**
	 * Builds the API url.
	 *
	 * @since 1.5.0
	 *
	 * @return string
	 */
	public function get_api_url() {
		return sprintf( '%s%s', trailingslashit( $this->settings['url'] ), static::API_PATH );
	}

	/**
	 * Fetch thumbnail using Azure API.
	 *
	 * @since 1.5.0
	 *
	 * @param array $data Data for an attachment image size.
	 * @return string|\WP_Error
	 */
	public function request_cropped_thumbnail( $data ) {
		$url = add_query_arg(
			[
				'height'        => $data['height'],
				'width'         => $data['width'],
				'smartCropping' => 'true',
			],
			$this->get_api_url()
		);

		$response = wp_remote_post(
			$url,
			[
				'body'    => wp_json_encode(
					[
						'url' => $data['url'],
					]
				),
				'headers' => [
					'Content-Type'              => 'application/json',
					'Ocp-Apim-Subscription-Key' => $this->settings['api_key'],
				],
			]
		);

		/**
		 * Fires after the request to the generateThumbnail smart-cropping endpoint has run.
		 *
		 * @since 1.5.0
		 * @hook classifai_smart_cropping_after_request
		 *
		 * @param {array|WP_Error} Response data or a WP_Error if the request failed.
		 * @param {string} The request URL with query args added.
		 * @param {array}  Array containing the image height and width.
		 */
		do_action( 'classifai_smart_cropping_after_request', $response, $url, $data );

		if ( is_wp_error( $response ) ) {
			return $response;
		}

		$response_body = wp_remote_retrieve_body( $response );

		if ( 200 === wp_remote_retrieve_response_code( $response ) ) {
			return $response_body;
		}

		$response_json = json_decode( $response_body );

		/**
		 * Fires when the generateThumbnail smart-cropping API response did not have a 200 status code.
		 *
		 * @since 1.5.0
		 * @hook classifai_smart_cropping_unsuccessful_response
		 *
		 * @param {array|WP_Error} Response data or a WP_Error if the request failed.
		 * @param {string} The request URL with query args added.
		 * @param {array}  Array containing the image height and width.
		 */
		do_action( 'classifai_smart_cropping_unsuccessful_response', $response, $url, $data );

		if ( ! empty( $response_json->code ) ) {
			return new \WP_Error( $response_json->code, $response_json->message );
		}

		if ( ! empty( $response_json->error ) ) {
			return new \WP_Error( $response_json->error->code, $response_json->error->message );
		}

		if ( ! empty( $response_json->errors ) ) {
			return new \WP_Error( 'classifai_smart_cropping_api_validation_errors', implode( ' ', $response_json->errors->smartCropping ) );
		}

		return new \WP_Error( 'classifai_smart_cropping_failed', 'A Smart Cropping error occurred.' );
	}
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://classifaiplugin.com/">ClassifAI Plugin</a> &bull;
		<a href="https://github.com/10up/classifai/">ClassifAI on GitHub</a> &bull;
		<a href="https://10up.com/careers">Careers at 10up</a>
	</footer>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="after_classifai_init.html">after_classifai_init</a></li><li><a href="before_classifai_init.html">before_classifai_init</a></li><li><a href="classifai_azure_read_after_request.html">classifai_azure_read_after_request</a></li><li><a href="classifai_computer_vision_caption_failed.html">classifai_computer_vision_caption_failed</a></li><li><a href="classifai_computer_vision_image_tag_failed.html">classifai_computer_vision_image_tag_failed</a></li><li><a href="classifai_ocr_after_request.html">classifai_ocr_after_request</a></li><li><a href="classifai_ocr_unsuccessful_response.html">classifai_ocr_unsuccessful_response</a></li><li><a href="classifai_smart_cropping_after_request.html">classifai_smart_cropping_after_request</a></li><li><a href="classifai_smart_cropping_unsuccessful_response.html">classifai_smart_cropping_unsuccessful_response</a></li></ul><h3>Filters</h3><ul><li><a href="classifai_all_post_statuses.html">classifai_all_post_statuses</a></li><li><a href="classifai_allowed_roles.html">classifai_allowed_roles</a></li><li><a href="classifai_audio_generation_initial_state.html">classifai_audio_generation_initial_state</a></li><li><a href="classifai_audio_generation_subsequent_state.html">classifai_audio_generation_subsequent_state</a></li><li><a href="classifai_azure_read_request_args.html">classifai_azure_read_request_args</a></li><li><a href="classifai_azure_read_result_max_page.html">classifai_azure_read_result_max_page</a></li><li><a href="classifai_azure_read_retry_interval.html">classifai_azure_read_retry_interval</a></li><li><a href="classifai_azure_read_should_process.html">classifai_azure_read_should_process</a></li><li><a href="classifai_azure_read_text_result.html">classifai_azure_read_text_result</a></li><li><a href="classifai_chatgpt_allowed_roles.html">classifai_chatgpt_allowed_roles</a></li><li><a href="classifai_chatgpt_content.html">classifai_chatgpt_content</a></li><li><a href="classifai_chatgpt_excerpt_prompt.html">classifai_chatgpt_excerpt_prompt</a></li><li><a href="classifai_chatgpt_excerpt_request_body.html">classifai_chatgpt_excerpt_request_body</a></li><li><a href="classifai_chatgpt_resize_content_request_body.html">classifai_chatgpt_resize_content_request_body</a></li><li><a href="classifai_chatgpt_title_prompt.html">classifai_chatgpt_title_prompt</a></li><li><a href="classifai_chatgpt_title_request_body.html">classifai_chatgpt_title_request_body</a></li><li><a href="classifai_classified_data.html">classifai_classified_data</a></li><li><a href="classifai_computer_vision_captions.html">classifai_computer_vision_captions</a></li><li><a href="classifai_computer_vision_image_tags.html">classifai_computer_vision_image_tags</a></li><li><a href="classifai_computer_vision_max_filesize.html">classifai_computer_vision_max_filesize</a></li><li><a href="classifai_dalle_caption.html">classifai_dalle_caption</a></li><li><a href="classifai_dalle_prompt.html">classifai_dalle_prompt</a></li><li><a href="classifai_dalle_request_body.html">classifai_dalle_request_body</a></li><li><a href="classifai_debug_information.html">classifai_debug_information</a></li><li><a href="classifai_disable_post_to_audio_block.html">classifai_disable_post_to_audio_block</a></li><li><a href="classifai_feature_threshold.html">classifai_feature_threshold</a></li><li><a href="classifai_generate_image_alt_tags_source_url.html">classifai_generate_image_alt_tags_source_url</a></li><li><a href="classifai_has_access.html">classifai_has_access</a></li><li><a href="classifai_is_%257B$feature%257D_enabled.html">classifai_is_{$feature}_enabled</a></li><li><a href="classifai_language_settings_post_statuses.html">classifai_language_settings_post_statuses</a></li><li><a href="classifai_language_settings_post_types.html">classifai_language_settings_post_types</a></li><li><a href="classifai_listen_to_this_post_text.html">classifai_listen_to_this_post_text</a></li><li><a href="classifai_normalize.html">classifai_normalize</a></li><li><a href="classifai_ocr_approved_media_types.html">classifai_ocr_approved_media_types</a></li><li><a href="classifai_ocr_should_process.html">classifai_ocr_should_process</a></li><li><a href="classifai_ocr_tag_confidence.html">classifai_ocr_tag_confidence</a></li><li><a href="classifai_ocr_tags.html">classifai_ocr_tags</a></li><li><a href="classifai_ocr_text.html">classifai_ocr_text</a></li><li><a href="classifai_ocr_text_post_args.html">classifai_ocr_text_post_args</a></li><li><a href="classifai_openai_api_request_get_options.html">classifai_openai_api_request_get_options</a></li><li><a href="classifai_openai_api_request_get_url.html">classifai_openai_api_request_get_url</a></li><li><a href="classifai_openai_api_request_post_form_options.html">classifai_openai_api_request_post_form_options</a></li><li><a href="classifai_openai_api_request_post_form_url.html">classifai_openai_api_request_post_form_url</a></li><li><a href="classifai_openai_api_request_post_options.html">classifai_openai_api_request_post_options</a></li><li><a href="classifai_openai_api_request_post_url.html">classifai_openai_api_request_post_url</a></li><li><a href="classifai_openai_api_response_get.html">classifai_openai_api_response_get</a></li><li><a href="classifai_openai_api_response_post.html">classifai_openai_api_response_post</a></li><li><a href="classifai_openai_api_response_post_form.html">classifai_openai_api_response_post_form</a></li><li><a href="classifai_openai_characters_in_token.html">classifai_openai_characters_in_token</a></li><li><a href="classifai_openai_dalle_allowed_image_roles.html">classifai_openai_dalle_allowed_image_roles</a></li><li><a href="classifai_openai_dalle_enable_image_gen.html">classifai_openai_dalle_enable_image_gen</a></li><li><a href="classifai_openai_embeddings_content.html">classifai_openai_embeddings_content</a></li><li><a href="classifai_openai_embeddings_post_statuses.html">classifai_openai_embeddings_post_statuses</a></li><li><a href="classifai_openai_embeddings_request_body.html">classifai_openai_embeddings_request_body</a></li><li><a href="classifai_openai_embeddings_should_classify.html">classifai_openai_embeddings_should_classify</a></li><li><a href="classifai_openai_embeddings_taxonomies.html">classifai_openai_embeddings_taxonomies</a></li><li><a href="classifai_openai_settings_post_statuses.html">classifai_openai_settings_post_statuses</a></li><li><a href="classifai_openai_settings_post_types.html">classifai_openai_settings_post_types</a></li><li><a href="classifai_openai_settings_taxonomies.html">classifai_openai_settings_taxonomies</a></li><li><a href="classifai_openai_tokens_per_word.html">classifai_openai_tokens_per_word</a></li><li><a href="classifai_post_statuses.html">classifai_post_statuses</a></li><li><a href="classifai_post_statuses_for_post_type_or_id.html">classifai_post_statuses_for_post_type_or_id</a></li><li><a href="classifai_post_types.html">classifai_post_types</a></li><li><a href="classifai_pre_render_post_audio_controls.html">classifai_pre_render_post_audio_controls</a></li><li><a href="classifai_recommended_block_attributes.html">classifai_recommended_block_attributes</a></li><li><a href="classifai_recommended_block_markup.html">classifai_recommended_block_markup</a></li><li><a href="classifai_recommended_content_post_args.html">classifai_recommended_content_post_args</a></li><li><a href="classifai_rest_bases.html">classifai_rest_bases</a></li><li><a href="classifai_services.html">classifai_services</a></li><li><a href="classifai_should_classify_post.html">classifai_should_classify_post</a></li><li><a href="classifai_should_crop_size.html">classifai_should_crop_size</a></li><li><a href="classifai_should_ocr_scan_image.html">classifai_should_ocr_scan_image</a></li><li><a href="classifai_should_register_save_post_handler.html">classifai_should_register_save_post_handler</a></li><li><a href="classifai_should_smart_crop_image.html">classifai_should_smart_crop_image</a></li><li><a href="classifai_smart_crop_max_pixel_dimension.html">classifai_smart_crop_max_pixel_dimension</a></li><li><a href="classifai_smart_crop_wp_filesystem.html">classifai_smart_crop_wp_filesystem</a></li><li><a href="classifai_smart_cropping_source_url.html">classifai_smart_cropping_source_url</a></li><li><a href="classifai_smart_cropping_thumb_file_name.html">classifai_smart_cropping_thumb_file_name</a></li><li><a href="classifai_taxonomy_for_feature.html">classifai_taxonomy_for_feature</a></li><li><a href="classifai_threshold.html">classifai_threshold</a></li><li><a href="classifai_whisper_transcribe_request_body.html">classifai_whisper_transcribe_request_body</a></li><li><a href="classifai_whisper_transcribe_result.html">classifai_whisper_transcribe_result</a></li><li><a href="classifai_%257B$this-_option_name%257D_enable_%257B$feature%257D.html">classifai_{$this->option_name}_enable_{$feature}</a></li><li><a href="%257B$this-_menu_slug%257D_providers.html">{$this->menu_slug}_providers</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-useful-snippets.html">Useful snippets</a></li><li><a href="tutorial-wp-cli.html">WP-CLI Commands</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
