<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Providers/Azure/OCR.php - 10up ClassifAI Hook Docs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: Providers/Azure/OCR.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Provides OCR detection with the Computer Vision service.
 *
 * @since 1.6.0
 * @package Classifai
 */

namespace Classifai\Providers\Azure;

use WP_Error;
use function Classifai\computer_vision_max_filesize;
use function Classifai\get_largest_size_and_dimensions_image_url;

/**
 * OCR class
 *
 * Connects to Computer Vision's ocr endpoint to detect text.
 *
 * @see https://docs.microsoft.com/en-us/rest/api/cognitiveservices/computervision/recognizeprintedtext/
 * @since 1.6.0
 */
class OCR {

	/**
	 * The Computer Vision API path to the OCR service.
	 *
	 * @since 1.6.0
	 *
	 * @var string
	 */
	const API_PATH = 'vision/v3.2/ocr/';

	/**
	 * ComputerVision settings.
	 *
	 * @since 1.6.0
	 *
	 * @var array
	 */
	private $settings;

	/**
	 * Force processing
	 *
	 * @since 1.6.0
	 *
	 * @var bool|object
	 */
	private $scan;

	/**
	 * Force processing
	 *
	 * @since 1.6.0
	 *
	 * @var boolean
	 */
	private $force;

	/**
	 * Media types to process.
	 *
	 * @since 1.6.0
	 *
	 * @var array
	 */
	private $media_to_process = [
		'bmp',
		'gif',
		'jpeg',
		'png',
	];

	/**
	 * OCR constructor
	 *
	 * @since 1.6.0
	 *
	 * @param array       $settings Computer Vision settings.
	 * @param bool|object $scan     Previously run image scan.
	 * @param boolean     $force    Whether to force processing or not.
	 */
	public function __construct( array $settings, $scan, bool $force ) {
		$this->settings = $settings;
		$this->scan     = $scan;
		$this->force    = $force;
	}

	/**
	 * Builds the API url.
	 *
	 * @since 1.6.0
	 *
	 * @return string
	 */
	public function get_api_url() {
		return sprintf( '%s%s', trailingslashit( $this->settings['url'] ), static::API_PATH );
	}

	/**
	 * Returns whether OCR processing should be applied to the attachment
	 *
	 * @since 1.6.0
	 *
	 * @param int $attachment_id Attachment ID.
	 * @return boolean
	 */
	public function should_process( int $attachment_id ) {
		// Bypass check if this is a force request
		if ( $this->force ) {
			return true;
		}

		$mime_type          = get_post_mime_type( $attachment_id );
		$matched_extensions = explode( '|', array_search( $mime_type, wp_get_mime_types(), true ) );
		$process            = false;

		/**
		 * Filters the media types that should be processed
		 *
		 * @since 1.6.0
		 * @hook classifai_ocr_approved_media_types
		 *
		 * @param {array} $media_types   The media types to process.
		 * @param {int}   $attachment_id The attachment ID.
		 *
		 * @return {array} Filtered media types.
		 */
		$approved_media_types = apply_filters( 'classifai_ocr_approved_media_types', $this->media_to_process, $attachment_id );

		foreach ( $matched_extensions as $ext ) {
			if ( in_array( $ext, $approved_media_types, true ) ) {
				$process = true;
			}
		}

		// If we have a proper image and a previous image scan, check
		// to see if we have proper tags set, with a high confidence
		if ( $process &amp;&amp; $this->scan &amp;&amp; ! empty( $this->scan->tags ) &amp;&amp; is_array( $this->scan->tags ) ) {

			/**
			 * Filters the tags we check for OCR processing
			 *
			 * @since 1.6.0
			 * @hook classifai_ocr_tags
			 *
			 * @param {array}       $tags          Tags to look for. Default handwriting and text.
			 * @param {int}         $attachment_id The attachment ID.
			 * @param {bool|object} $scan          Previously run scan.
			 *
			 * @return {array} Filtered tags.
			 */
			$tags = apply_filters( 'classifai_ocr_tags', [ 'handwriting', 'text' ], $attachment_id, $this->scan );

			/**
			 * Filters the tag confidence level for OCR processing
			 *
			 * @since 1.6.0
			 * @hook classifai_ocr_tag_confidence
			 *
			 * @param {int}         $confidence    The minimum confidence level. Default 90.
			 * @param {int}         $attachment_id The attachment ID.
			 * @param {bool|object} $scan          Previously run scan.
			 *
			 * @return {int} Confidence level.
			 */
			$tag_confidence = apply_filters( 'classifai_ocr_tag_confidence', 90, $attachment_id, $this->scan );

			foreach ( $this->scan->tags as $tag ) {
				if ( in_array( $tag->name, $tags, true ) &amp;&amp; $tag->confidence * 100 >= $tag_confidence ) {
					$process = true;
					break;
				}
			}
		}

		/**
		 * Filters whether to run OCR processing on this media item
		 *
		 * @since 1.6.0
		 * @hook classifai_ocr_should_process
		 *
		 * @param {bool}        $process       Whether to run OCR processing or not.
		 * @param {int}         $attachment_id The attachment ID.
		 * @param {bool|object} $scan          Previously run scan.
		 *
		 * @return {bool} Whether this attachment should have OCR processing.
		 */
		return apply_filters( 'classifai_ocr_should_process', $process, $attachment_id, $this->scan );
	}

	/**
	 * Get and save the OCR data
	 *
	 * @since 1.6.0
	 *
	 * @param array   $metadata      Attachment metadata.
	 * @param integer $attachment_id Attachment ID.
	 * @return string|WP_Error
	 */
	public function generate_ocr_data( array $metadata, int $attachment_id ) {
		$rtn = '';

		if ( ! $this->should_process( $attachment_id ) ) {
			return new WP_Error( 'process_error', esc_html__( 'Image does not meet processing requirements.', 'classifai' ), $metadata );
		}

		$url = get_largest_size_and_dimensions_image_url(
			get_attached_file( $attachment_id ),
			wp_get_attachment_url( $attachment_id, 'full' ),
			$metadata,
			[ 50, 4200 ],
			[ 50, 4200 ],
			computer_vision_max_filesize()
		);

		// If a properly sized image isn't found, return
		if ( ! $url ) {
			return new WP_Error( 'size_error', esc_html__( 'Image does not meet size requirements. Please ensure it is at least 50x50 but less than 4200x4200 and smaller than 4MB.', 'classifai' ), $metadata );
		}

		$scan = $this->process( $url );

		set_transient( 'classifai_azure_computer_vision_ocr_latest_response', $scan, DAY_IN_SECONDS * 30 );

		if ( ! is_wp_error( $scan ) &amp;&amp; isset( $scan->regions ) ) {
			$text = [];

			// Iterate down the chain to find the text we want
			foreach ( $scan->regions as $region ) {
				foreach ( $region->lines as $lines ) {
					foreach ( $lines->words as $word ) {
						if ( isset( $word->text ) ) {
							$text[] = $word->text;
						}
					}
				}
			}

			if ( ! empty( $text ) ) {

				/**
				 * Filter the text returned from the API.
				 *
				 * @since 1.6.0
				 * @hook classifai_ocr_text
				 *
				 * @param {string} $text The returned text data.
				 * @param {object} $scan The full scan results from the API.
				 *
				 * @return {string} The filtered text data.
				 */
				$text = apply_filters( 'classifai_ocr_text', implode( ' ', $text ), $scan );

				$post_args = [
					'ID'           => $attachment_id,
					'post_content' => sanitize_text_field( $text ),
				];

				/**
				 * Filter the post arguments before saving the text to post_content.
				 *
				 * This enables text to be stored in a different post or post meta field,
				 * or do other post data setting based on scan results.
				 *
				 * @since 1.6.0
				 * @hook classifai_ocr_text_post_args
				 *
				 * @param {string} $post_args     Array of post data for the attachment post update. Defaults to `ID` and `post_content`.
				 * @param {int}    $attachment_id ID of the attachment post.
				 * @param {object} $scan          The full scan results from the API.
				 * @param {string} $text          The text data to be saved.
				 * @param {object} $scan          The full scan results from the API.
				 *
				 * @return {string} The filtered text data.
				 */
				$post_args = apply_filters( 'classifai_ocr_text_post_args', $post_args, $attachment_id, $text, $scan );

				wp_update_post( $post_args );

				$rtn = $text;

				// Save all the results for later
				update_post_meta( $attachment_id, 'classifai_computer_vision_ocr', $scan );
			}
		} else {
			$rtn = $scan;
		}

		return $rtn;
	}

	/**
	 * Run OCR processing using the Azure API
	 *
	 * @since 1.6.0
	 *
	 * @param string $url Media URL.
	 * @return object|WP_Error
	 */
	public function process( string $url ) {
		// Check if valid authentication is in place.
		if ( empty( $this->settings ) || ( isset( $this->settings['authenticated'] ) &amp;&amp; false === $this->settings['authenticated'] ) ) {
			return new WP_Error( 'auth', esc_html__( 'Please set up valid authentication with Azure.', 'classifai' ) );
		}

		$response = wp_remote_post(
			$this->get_api_url(),
			[
				'body'    => wp_json_encode(
					[
						'url' => $url,
					]
				),
				'headers' => [
					'Content-Type'              => 'application/json',
					'Ocp-Apim-Subscription-Key' => $this->settings['api_key'],
				],
			]
		);

		/**
		 * Fires after the request to the ocr endpoint has run.
		 *
		 * @since 1.6.0
		 * @hook classifai_ocr_after_request
		 *
		 * @param {array|WP_Error} Response data or a WP_Error if the request failed.
		 * @param {string} The attachment URL.
		 */
		do_action( 'classifai_ocr_after_request', $response, $url );

		if ( ! is_wp_error( $response ) ) {
			$body = json_decode( wp_remote_retrieve_body( $response ) );

			if ( isset( $body->message ) ) {
				$error_message = $body->message;
			} elseif ( isset( $body->error->message ) ) {
				$error_message = $body->error->message;
			} else {
				$error_message = false;
			}

			if ( 200 !== wp_remote_retrieve_response_code( $response ) &amp;&amp; $error_message ) {
				/**
				 * Fires when the ocr API response did not succeed.
				 *
				 * @since 1.6.0
				 * @hook classifai_ocr_unsuccessful_response
				 *
				 * @param {array|WP_Error} Response data or a WP_Error if the request failed.
				 * @param {string} The attachment URL.
				 */
				do_action( 'classifai_ocr_unsuccessful_response', $response, $url );

				$rtn = new WP_Error( $body->code ?? 'error', $error_message, $body );
			} else {
				$rtn = $body;
			}
		} else {
			$rtn = $response;
		}

		return $rtn;
	}

}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://classifaiplugin.com/">ClassifAI Plugin</a> &bull;
		<a href="https://github.com/10up/classifai/">ClassifAI on GitHub</a> &bull;
		<a href="https://10up.com/careers">Careers at 10up</a>
	</footer>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="after_classifai_init.html">after_classifai_init</a></li><li><a href="before_classifai_init.html">before_classifai_init</a></li><li><a href="classifai_azure_read_after_request.html">classifai_azure_read_after_request</a></li><li><a href="classifai_computer_vision_caption_failed.html">classifai_computer_vision_caption_failed</a></li><li><a href="classifai_computer_vision_image_tag_failed.html">classifai_computer_vision_image_tag_failed</a></li><li><a href="classifai_ocr_after_request.html">classifai_ocr_after_request</a></li><li><a href="classifai_ocr_unsuccessful_response.html">classifai_ocr_unsuccessful_response</a></li><li><a href="classifai_smart_cropping_after_request.html">classifai_smart_cropping_after_request</a></li><li><a href="classifai_smart_cropping_unsuccessful_response.html">classifai_smart_cropping_unsuccessful_response</a></li></ul><h3>Filters</h3><ul><li><a href="classifai_all_post_statuses.html">classifai_all_post_statuses</a></li><li><a href="classifai_audio_generation_initial_state.html">classifai_audio_generation_initial_state</a></li><li><a href="classifai_audio_generation_subsequent_state.html">classifai_audio_generation_subsequent_state</a></li><li><a href="classifai_azure_read_request_args.html">classifai_azure_read_request_args</a></li><li><a href="classifai_azure_read_result_max_page.html">classifai_azure_read_result_max_page</a></li><li><a href="classifai_azure_read_retry_interval.html">classifai_azure_read_retry_interval</a></li><li><a href="classifai_azure_read_should_process.html">classifai_azure_read_should_process</a></li><li><a href="classifai_azure_read_text_result.html">classifai_azure_read_text_result</a></li><li><a href="classifai_chatgpt_allowed_roles.html">classifai_chatgpt_allowed_roles</a></li><li><a href="classifai_chatgpt_content.html">classifai_chatgpt_content</a></li><li><a href="classifai_chatgpt_excerpt_prompt.html">classifai_chatgpt_excerpt_prompt</a></li><li><a href="classifai_chatgpt_excerpt_request_body.html">classifai_chatgpt_excerpt_request_body</a></li><li><a href="classifai_chatgpt_resize_content_request_body.html">classifai_chatgpt_resize_content_request_body</a></li><li><a href="classifai_chatgpt_title_prompt.html">classifai_chatgpt_title_prompt</a></li><li><a href="classifai_chatgpt_title_request_body.html">classifai_chatgpt_title_request_body</a></li><li><a href="classifai_classified_data.html">classifai_classified_data</a></li><li><a href="classifai_computer_vision_captions.html">classifai_computer_vision_captions</a></li><li><a href="classifai_computer_vision_image_tags.html">classifai_computer_vision_image_tags</a></li><li><a href="classifai_computer_vision_max_filesize.html">classifai_computer_vision_max_filesize</a></li><li><a href="classifai_dalle_caption.html">classifai_dalle_caption</a></li><li><a href="classifai_dalle_prompt.html">classifai_dalle_prompt</a></li><li><a href="classifai_dalle_request_body.html">classifai_dalle_request_body</a></li><li><a href="classifai_debug_information.html">classifai_debug_information</a></li><li><a href="classifai_disable_post_to_audio_block.html">classifai_disable_post_to_audio_block</a></li><li><a href="classifai_feature_threshold.html">classifai_feature_threshold</a></li><li><a href="classifai_generate_image_alt_tags_source_url.html">classifai_generate_image_alt_tags_source_url</a></li><li><a href="classifai_language_settings_post_statuses.html">classifai_language_settings_post_statuses</a></li><li><a href="classifai_language_settings_post_types.html">classifai_language_settings_post_types</a></li><li><a href="classifai_listen_to_this_post_text.html">classifai_listen_to_this_post_text</a></li><li><a href="classifai_normalize.html">classifai_normalize</a></li><li><a href="classifai_ocr_approved_media_types.html">classifai_ocr_approved_media_types</a></li><li><a href="classifai_ocr_should_process.html">classifai_ocr_should_process</a></li><li><a href="classifai_ocr_tag_confidence.html">classifai_ocr_tag_confidence</a></li><li><a href="classifai_ocr_tags.html">classifai_ocr_tags</a></li><li><a href="classifai_ocr_text.html">classifai_ocr_text</a></li><li><a href="classifai_ocr_text_post_args.html">classifai_ocr_text_post_args</a></li><li><a href="classifai_openai_api_request_get_options.html">classifai_openai_api_request_get_options</a></li><li><a href="classifai_openai_api_request_get_url.html">classifai_openai_api_request_get_url</a></li><li><a href="classifai_openai_api_request_post_form_options.html">classifai_openai_api_request_post_form_options</a></li><li><a href="classifai_openai_api_request_post_form_url.html">classifai_openai_api_request_post_form_url</a></li><li><a href="classifai_openai_api_request_post_options.html">classifai_openai_api_request_post_options</a></li><li><a href="classifai_openai_api_request_post_url.html">classifai_openai_api_request_post_url</a></li><li><a href="classifai_openai_api_response_get.html">classifai_openai_api_response_get</a></li><li><a href="classifai_openai_api_response_post.html">classifai_openai_api_response_post</a></li><li><a href="classifai_openai_api_response_post_form.html">classifai_openai_api_response_post_form</a></li><li><a href="classifai_openai_characters_in_token.html">classifai_openai_characters_in_token</a></li><li><a href="classifai_openai_chatgpt_%257B$feature%257D.html">classifai_openai_chatgpt_{$feature}</a></li><li><a href="classifai_openai_dalle_allowed_image_roles.html">classifai_openai_dalle_allowed_image_roles</a></li><li><a href="classifai_openai_dalle_enable_image_gen.html">classifai_openai_dalle_enable_image_gen</a></li><li><a href="classifai_openai_embeddings_content.html">classifai_openai_embeddings_content</a></li><li><a href="classifai_openai_embeddings_post_statuses.html">classifai_openai_embeddings_post_statuses</a></li><li><a href="classifai_openai_embeddings_request_body.html">classifai_openai_embeddings_request_body</a></li><li><a href="classifai_openai_embeddings_should_classify.html">classifai_openai_embeddings_should_classify</a></li><li><a href="classifai_openai_embeddings_taxonomies.html">classifai_openai_embeddings_taxonomies</a></li><li><a href="classifai_openai_settings_post_statuses.html">classifai_openai_settings_post_statuses</a></li><li><a href="classifai_openai_settings_post_types.html">classifai_openai_settings_post_types</a></li><li><a href="classifai_openai_settings_taxonomies.html">classifai_openai_settings_taxonomies</a></li><li><a href="classifai_openai_tokens_per_word.html">classifai_openai_tokens_per_word</a></li><li><a href="classifai_post_statuses.html">classifai_post_statuses</a></li><li><a href="classifai_post_statuses_for_post_type_or_id.html">classifai_post_statuses_for_post_type_or_id</a></li><li><a href="classifai_post_types.html">classifai_post_types</a></li><li><a href="classifai_pre_render_post_audio_controls.html">classifai_pre_render_post_audio_controls</a></li><li><a href="classifai_recommended_block_attributes.html">classifai_recommended_block_attributes</a></li><li><a href="classifai_recommended_block_markup.html">classifai_recommended_block_markup</a></li><li><a href="classifai_recommended_content_post_args.html">classifai_recommended_content_post_args</a></li><li><a href="classifai_rest_bases.html">classifai_rest_bases</a></li><li><a href="classifai_services.html">classifai_services</a></li><li><a href="classifai_should_classify_post.html">classifai_should_classify_post</a></li><li><a href="classifai_should_crop_size.html">classifai_should_crop_size</a></li><li><a href="classifai_should_ocr_scan_image.html">classifai_should_ocr_scan_image</a></li><li><a href="classifai_should_register_save_post_handler.html">classifai_should_register_save_post_handler</a></li><li><a href="classifai_should_smart_crop_image.html">classifai_should_smart_crop_image</a></li><li><a href="classifai_smart_crop_max_pixel_dimension.html">classifai_smart_crop_max_pixel_dimension</a></li><li><a href="classifai_smart_crop_wp_filesystem.html">classifai_smart_crop_wp_filesystem</a></li><li><a href="classifai_smart_cropping_source_url.html">classifai_smart_cropping_source_url</a></li><li><a href="classifai_smart_cropping_thumb_file_name.html">classifai_smart_cropping_thumb_file_name</a></li><li><a href="classifai_taxonomy_for_feature.html">classifai_taxonomy_for_feature</a></li><li><a href="classifai_whisper_transcribe_request_body.html">classifai_whisper_transcribe_request_body</a></li><li><a href="classifai_whisper_transcribe_result.html">classifai_whisper_transcribe_result</a></li><li><a href="%257B$this-_menu_slug%257D_providers.html">{$this->menu_slug}_providers</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-useful-snippets.html">Useful snippets</a></li><li><a href="tutorial-wp-cli.html">WP-CLI Commands</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
