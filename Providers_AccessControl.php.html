<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Providers/AccessControl.php - 10up ClassifAI Hook Docs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: Providers/AccessControl.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Class for handling the access control for ClassifAI features.
 *
 * @package Classifai
 * @since 2.4.0
 */

namespace Classifai\Providers;

class AccessControl {

	/**
	 * The provider name.
	 *
	 * @var Provider $provider
	 */
	protected $provider;

	/**
	 * The feature name.
	 *
	 * @var string $feature
	 */
	protected $feature;

	/**
	 * The provider settings.
	 *
	 * @var array $settings
	 */
	protected $settings;

	/**
	 * The role based access key.
	 *
	 * @var string $role_based_access_key
	 */
	protected $role_based_access_key;

	/**
	 * The roles key.
	 *
	 * @var string $roles_key
	 */
	protected $roles_key;

	/**
	 * The user based access key.
	 *
	 * @var string $user_based_access_key
	 */
	protected $user_based_access_key;

	/**
	 * The user based opt out key.
	 *
	 * @var string $user_based_opt_out_key
	 */
	protected $user_based_opt_out_key;

	/**
	 * The users key.
	 *
	 * @var string $users_key
	 */
	protected $users_key;

	/**
	 * Constructor.
	 *
	 * @param Provider $provider The provider class instance.
	 * @param string   $feature  The feature name.
	 */
	public function __construct( Provider $provider, string $feature ) {
		$this->provider = $provider;
		$this->feature  = $feature;

		$this->role_based_access_key  = $feature . '_role_based_access';
		$this->roles_key              = $feature . '_roles';
		$this->user_based_access_key  = $feature . '_user_based_access';
		$this->user_based_opt_out_key = $feature . '_user_based_opt_out';
		$this->users_key              = $feature . '_users';
	}

	/**
	 * Get settings for the current feature.
	 *
	 * @return array
	 */
	public function get_settings() {
		if ( is_null( $this->settings ) ) {
			$this->settings = $this->provider->get_settings();
		}
		return $this->settings;
	}

	/**
	 * Determines whether user-based access control is enabled for the current feature.
	 *
	 * @return boolean
	 */
	public function is_user_based_access_enabled() {
		$settings = $this->get_settings();
		return isset( $settings[ $this->user_based_access_key ] ) &amp;&amp; 1 === (int) $settings[ $this->user_based_access_key ];
	}

	/**
	 * Determines whether user-based opt-out is enabled for the current feature.
	 *
	 * @return boolean
	 */
	public function is_user_based_opt_out_enabled() {
		$settings = $this->get_settings();
		return isset( $settings[ $this->user_based_opt_out_key ] ) &amp;&amp; 1 === (int) $settings[ $this->user_based_opt_out_key ];
	}

	/**
	 * Determines whether role-based access control is enabled for the current feature.
	 *
	 * @return boolean
	 */
	public function is_role_based_access_enabled() {
		$settings = $this->get_settings();
		return isset( $settings[ $this->role_based_access_key ] ) &amp;&amp; 1 === (int) $settings[ $this->role_based_access_key ];
	}

	/**
	 * Get the list of allowed roles for the current feature.
	 *
	 * @return array
	 */
	public function get_allowed_roles() {
		$settings  = $this->get_settings();
		$roles_key = $this->roles_key;
		// Backward compatibility for old roles keys.
		switch ( $this->feature ) {
			case 'title_generation':
				if ( ! isset( $settings[ $this->roles_key ] ) &amp;&amp; isset( $settings['title_roles'] ) ) {
					$roles_key = 'title_roles';
				}
				break;

			case 'excerpt_generation':
			case 'speech_to_text':
			case 'image_generation':
				if ( ! isset( $settings[ $this->roles_key ] ) &amp;&amp; isset( $settings['roles'] ) ) {
					$roles_key = 'roles';
				}
				break;

			default:
				break;
		}

		return $settings[ $roles_key ] ?? [];
	}

	/**
	 * Get the list of allowed users for the current feature.
	 *
	 * @return array
	 */
	public function get_allowed_users() {
		$settings = $this->get_settings();
		$users    = $settings[ $this->users_key ] ?? [];
		return array_map( 'absint', $users );
	}

	/**
	 * Add settings fields for Role/User based access.
	 *
	 * @param string $section Settings section.
	 * @return void
	 */
	public function add_settings( string $section = '' ) {
		$default_settings = $this->provider->get_default_settings();
		$settings         = $this->get_settings();

		$option_name = $this->provider->get_option_name();
		if ( empty( $section ) ) {
			$section = $this->provider->get_option_name();
		}

		// Backward compatibility for old roles keys.
		$backward_compatible_roles_key = '';
		switch ( $this->feature ) {
			case 'title_generation':
				$backward_compatible_roles_key = 'title_roles';
				break;

			case 'excerpt_generation':
			case 'speech_to_text':
			case 'image_generation':
				$backward_compatible_roles_key = 'roles';
				break;

			default:
				break;
		}

		$default_settings = array_merge(
			$this->provider->get_default_settings(),
			$default_settings,
		);

		add_settings_field(
			$this->role_based_access_key,
			esc_html__( 'Enable role-based access', 'classifai' ),
			[ $this->provider, 'render_input' ],
			$option_name,
			$section,
			[
				'label_for'     => $this->role_based_access_key,
				'input_type'    => 'checkbox',
				'default_value' => $default_settings[ $this->role_based_access_key ],
				'description'   => __( 'Enables ability to select which roles can access this feature.', 'classifai' ),
				'class'         => 'classifai-role-based-access',
			]
		);

		// Add hidden class if role-based access is disabled.
		$class = 'allowed_roles_row';
		if ( ! isset( $settings[ $this->role_based_access_key ] ) || '1' !== $settings[ $this->role_based_access_key ] ) {
			$class .= ' hidden';
		}

		add_settings_field(
			$this->roles_key,
			esc_html__( 'Allowed roles', 'classifai' ),
			[ $this->provider, 'render_checkbox_group' ],
			$option_name,
			$section,
			[
				'label_for'               => $this->roles_key,
				'options'                 => $this->provider->get_roles(),
				'default_values'          => $default_settings[ $this->roles_key ],
				'description'             => __( 'Choose which roles are allowed to access this feature.', 'classifai' ),
				'class'                   => $class,
				'backward_compatible_key' => $backward_compatible_roles_key,
			]
		);

		add_settings_field(
			$this->user_based_access_key,
			esc_html__( 'Enable user-based access', 'classifai' ),
			[ $this->provider, 'render_input' ],
			$option_name,
			$section,
			[
				'label_for'     => $this->user_based_access_key,
				'input_type'    => 'checkbox',
				'default_value' => $default_settings[ $this->user_based_access_key ],
				'description'   => __( 'Enables ability to select which users can access this feature.', 'classifai' ),
				'class'         => 'classifai-user-based-access',
			]
		);

		// Add hidden class if user-based access is disabled.
		$users_class = 'allowed_users_row';
		if ( ! isset( $settings[ $this->user_based_access_key ] ) || '1' !== $settings[ $this->user_based_access_key ] ) {
			$users_class .= ' hidden';
		}

		add_settings_field(
			$this->users_key,
			esc_html__( 'Allowed users', 'classifai' ),
			[ $this->provider, 'render_allowed_users' ],
			$option_name,
			$section,
			[
				'label_for'     => $this->users_key,
				'default_value' => $default_settings[ $this->users_key ],
				'description'   => __( 'Users who have access to this feature.', 'classifai' ),
				'class'         => $users_class,
			]
		);

		add_settings_field(
			$this->user_based_opt_out_key,
			esc_html__( 'Enable user-based opt-out', 'classifai' ),
			[ $this->provider, 'render_input' ],
			$option_name,
			$section,
			[
				'label_for'     => $this->user_based_opt_out_key,
				'input_type'    => 'checkbox',
				'default_value' => $default_settings[ $this->user_based_opt_out_key ],
				'description'   => __( 'Enables ability for users to opt-out from their user profile page.', 'classifai' ),
				'class'         => 'classifai-user-based-opt-out',
			]
		);
	}

	/**
	 * Sanitization for the roles/users access options being saved.
	 *
	 * @param array $settings Array of settings about to be saved.
	 *
	 * @return array The sanitized settings to be saved.
	 */
	public function sanitize_settings( array $settings ) {
		$new_settings = [];

		if ( empty( $settings[ $this->role_based_access_key ] ) || 1 !== (int) $settings[ $this->role_based_access_key ] ) {
			$new_settings[ $this->role_based_access_key ] = 'no';
		} else {
			$new_settings[ $this->role_based_access_key ] = '1';
		}

		// Allowed roles.
		if ( isset( $settings[ $this->roles_key ] ) &amp;&amp; is_array( $settings[ $this->roles_key ] ) ) {
			$new_settings[ $this->roles_key ] = array_map( 'sanitize_text_field', $settings[ $this->roles_key ] );
		} else {
			$new_settings[ $this->roles_key ] = array_keys( get_editable_roles() ?? [] );
		}

		if ( empty( $settings[ $this->user_based_access_key ] ) || 1 !== (int) $settings[ $this->user_based_access_key ] ) {
			$new_settings[ $this->user_based_access_key ] = 'no';
		} else {
			$new_settings[ $this->user_based_access_key ] = '1';
		}

		// Allowed users.
		if ( isset( $settings[ $this->users_key ] ) &amp;&amp; ! empty( $settings[ $this->users_key ] ) ) {
			if ( is_array( $settings[ $this->users_key ] ) ) {
				$new_settings[ $this->users_key ] = array_map( 'absint', $settings[ $this->users_key ] );
			} else {
				$new_settings[ $this->users_key ] = array_map( 'absint', explode( ',', $settings[ $this->users_key ] ) );
			}
		} else {
			$new_settings[ $this->users_key ] = array();
		}

		// User-based opt-out.
		if ( empty( $settings[ $this->user_based_opt_out_key ] ) || 1 !== (int) $settings[ $this->user_based_opt_out_key ] ) {
			$new_settings[ $this->user_based_opt_out_key ] = 'no';
		} else {
			$new_settings[ $this->user_based_opt_out_key ] = '1';
		}
		return $new_settings;
	}

	/**
	 * Determine if the current user has access of the feature
	 *
	 * @param int $user_id User ID.
	 * @return bool
	 */
	public function has_access( $user_id = null ) {
		if ( ! $user_id ) {
			$user_id = get_current_user_id();
		}
		$user_id    = (int) $user_id;
		$user       = get_user_by( 'id', $user_id );
		$user_roles = $user->roles ?? [];
		$access     = false;
		$settings   = $this->get_settings();

		$feature_roles = $this->get_allowed_roles();
		$feature_users = $this->get_allowed_users();

		/*
		 * Checks if Role-based access is enabled and user role has access to the feature.
		 */
		if ( $this->is_role_based_access_enabled() ) {
			$access = ( ! empty( $feature_roles ) &amp;&amp; ! empty( array_intersect( $user_roles, $feature_roles ) ) );
		}

		/*
		 * Checks if User-based access is enabled and user has access to the feature.
		 */
		if ( ! $access &amp;&amp; $this->is_user_based_access_enabled() ) {
			$access = ( ! empty( $feature_users ) &amp;&amp; ! empty( in_array( $user_id, $feature_users, true ) ) );
		}

		/*
		 * Checks if User-based opt-out is enabled and user has opted out from the feature.
		 */
		if ( $access &amp;&amp; $this->is_user_based_opt_out_enabled() ) {
			$opted_out_features = (array) get_user_meta( $user_id, 'classifai_opted_out_features', true );
			$access             = ( ! in_array( $this->feature, $opted_out_features, true ) );
		}

		/**
		 * Filter to override user access to a ClassifAI feature.
		 *
		 * @since 2.4.0
		 * @hook classifai_has_access
		 *
		 * @param {bool}   $access   Current access value.
		 * @param {string} $feature  Feature name.
		 * @param {int}    $user_id  User ID.
		 * @param {array}  $settings Feature settings.
		 *
		 * @return {bool} Should the user have access?
		 */
		return apply_filters( 'classifai_has_access', $access, $this->feature, $user_id, $settings );
	}
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://classifaiplugin.com/">ClassifAI Plugin</a> &bull;
		<a href="https://github.com/10up/classifai/">ClassifAI on GitHub</a> &bull;
		<a href="https://10up.com/careers">Careers at 10up</a>
	</footer>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="after_classifai_init.html">after_classifai_init</a></li><li><a href="before_classifai_init.html">before_classifai_init</a></li><li><a href="classifai_azure_read_after_request.html">classifai_azure_read_after_request</a></li><li><a href="classifai_computer_vision_caption_failed.html">classifai_computer_vision_caption_failed</a></li><li><a href="classifai_computer_vision_image_tag_failed.html">classifai_computer_vision_image_tag_failed</a></li><li><a href="classifai_ocr_after_request.html">classifai_ocr_after_request</a></li><li><a href="classifai_ocr_unsuccessful_response.html">classifai_ocr_unsuccessful_response</a></li><li><a href="classifai_smart_cropping_after_request.html">classifai_smart_cropping_after_request</a></li><li><a href="classifai_smart_cropping_unsuccessful_response.html">classifai_smart_cropping_unsuccessful_response</a></li></ul><h3>Filters</h3><ul><li><a href="classifai_all_post_statuses.html">classifai_all_post_statuses</a></li><li><a href="classifai_allowed_roles.html">classifai_allowed_roles</a></li><li><a href="classifai_audio_generation_initial_state.html">classifai_audio_generation_initial_state</a></li><li><a href="classifai_audio_generation_subsequent_state.html">classifai_audio_generation_subsequent_state</a></li><li><a href="classifai_azure_read_request_args.html">classifai_azure_read_request_args</a></li><li><a href="classifai_azure_read_result_max_page.html">classifai_azure_read_result_max_page</a></li><li><a href="classifai_azure_read_retry_interval.html">classifai_azure_read_retry_interval</a></li><li><a href="classifai_azure_read_should_process.html">classifai_azure_read_should_process</a></li><li><a href="classifai_azure_read_text_result.html">classifai_azure_read_text_result</a></li><li><a href="classifai_chatgpt_allowed_roles.html">classifai_chatgpt_allowed_roles</a></li><li><a href="classifai_chatgpt_content.html">classifai_chatgpt_content</a></li><li><a href="classifai_chatgpt_excerpt_prompt.html">classifai_chatgpt_excerpt_prompt</a></li><li><a href="classifai_chatgpt_excerpt_request_body.html">classifai_chatgpt_excerpt_request_body</a></li><li><a href="classifai_chatgpt_resize_content_request_body.html">classifai_chatgpt_resize_content_request_body</a></li><li><a href="classifai_chatgpt_title_prompt.html">classifai_chatgpt_title_prompt</a></li><li><a href="classifai_chatgpt_title_request_body.html">classifai_chatgpt_title_request_body</a></li><li><a href="classifai_classified_data.html">classifai_classified_data</a></li><li><a href="classifai_computer_vision_captions.html">classifai_computer_vision_captions</a></li><li><a href="classifai_computer_vision_image_tags.html">classifai_computer_vision_image_tags</a></li><li><a href="classifai_computer_vision_max_filesize.html">classifai_computer_vision_max_filesize</a></li><li><a href="classifai_dalle_caption.html">classifai_dalle_caption</a></li><li><a href="classifai_dalle_prompt.html">classifai_dalle_prompt</a></li><li><a href="classifai_dalle_request_body.html">classifai_dalle_request_body</a></li><li><a href="classifai_debug_information.html">classifai_debug_information</a></li><li><a href="classifai_disable_post_to_audio_block.html">classifai_disable_post_to_audio_block</a></li><li><a href="classifai_feature_threshold.html">classifai_feature_threshold</a></li><li><a href="classifai_generate_image_alt_tags_source_url.html">classifai_generate_image_alt_tags_source_url</a></li><li><a href="classifai_has_access.html">classifai_has_access</a></li><li><a href="classifai_is_%257B$feature%257D_enabled.html">classifai_is_{$feature}_enabled</a></li><li><a href="classifai_language_settings_post_statuses.html">classifai_language_settings_post_statuses</a></li><li><a href="classifai_language_settings_post_types.html">classifai_language_settings_post_types</a></li><li><a href="classifai_listen_to_this_post_text.html">classifai_listen_to_this_post_text</a></li><li><a href="classifai_normalize.html">classifai_normalize</a></li><li><a href="classifai_ocr_approved_media_types.html">classifai_ocr_approved_media_types</a></li><li><a href="classifai_ocr_should_process.html">classifai_ocr_should_process</a></li><li><a href="classifai_ocr_tag_confidence.html">classifai_ocr_tag_confidence</a></li><li><a href="classifai_ocr_tags.html">classifai_ocr_tags</a></li><li><a href="classifai_ocr_text.html">classifai_ocr_text</a></li><li><a href="classifai_ocr_text_post_args.html">classifai_ocr_text_post_args</a></li><li><a href="classifai_openai_api_request_get_options.html">classifai_openai_api_request_get_options</a></li><li><a href="classifai_openai_api_request_get_url.html">classifai_openai_api_request_get_url</a></li><li><a href="classifai_openai_api_request_post_form_options.html">classifai_openai_api_request_post_form_options</a></li><li><a href="classifai_openai_api_request_post_form_url.html">classifai_openai_api_request_post_form_url</a></li><li><a href="classifai_openai_api_request_post_options.html">classifai_openai_api_request_post_options</a></li><li><a href="classifai_openai_api_request_post_url.html">classifai_openai_api_request_post_url</a></li><li><a href="classifai_openai_api_response_get.html">classifai_openai_api_response_get</a></li><li><a href="classifai_openai_api_response_post.html">classifai_openai_api_response_post</a></li><li><a href="classifai_openai_api_response_post_form.html">classifai_openai_api_response_post_form</a></li><li><a href="classifai_openai_characters_in_token.html">classifai_openai_characters_in_token</a></li><li><a href="classifai_openai_dalle_allowed_image_roles.html">classifai_openai_dalle_allowed_image_roles</a></li><li><a href="classifai_openai_dalle_enable_image_gen.html">classifai_openai_dalle_enable_image_gen</a></li><li><a href="classifai_openai_embeddings_content.html">classifai_openai_embeddings_content</a></li><li><a href="classifai_openai_embeddings_post_statuses.html">classifai_openai_embeddings_post_statuses</a></li><li><a href="classifai_openai_embeddings_request_body.html">classifai_openai_embeddings_request_body</a></li><li><a href="classifai_openai_embeddings_should_classify.html">classifai_openai_embeddings_should_classify</a></li><li><a href="classifai_openai_embeddings_taxonomies.html">classifai_openai_embeddings_taxonomies</a></li><li><a href="classifai_openai_settings_post_statuses.html">classifai_openai_settings_post_statuses</a></li><li><a href="classifai_openai_settings_post_types.html">classifai_openai_settings_post_types</a></li><li><a href="classifai_openai_settings_taxonomies.html">classifai_openai_settings_taxonomies</a></li><li><a href="classifai_openai_tokens_per_word.html">classifai_openai_tokens_per_word</a></li><li><a href="classifai_post_statuses.html">classifai_post_statuses</a></li><li><a href="classifai_post_statuses_for_post_type_or_id.html">classifai_post_statuses_for_post_type_or_id</a></li><li><a href="classifai_post_types.html">classifai_post_types</a></li><li><a href="classifai_pre_render_post_audio_controls.html">classifai_pre_render_post_audio_controls</a></li><li><a href="classifai_recommended_block_attributes.html">classifai_recommended_block_attributes</a></li><li><a href="classifai_recommended_block_markup.html">classifai_recommended_block_markup</a></li><li><a href="classifai_recommended_content_post_args.html">classifai_recommended_content_post_args</a></li><li><a href="classifai_rest_bases.html">classifai_rest_bases</a></li><li><a href="classifai_services.html">classifai_services</a></li><li><a href="classifai_should_classify_post.html">classifai_should_classify_post</a></li><li><a href="classifai_should_crop_size.html">classifai_should_crop_size</a></li><li><a href="classifai_should_ocr_scan_image.html">classifai_should_ocr_scan_image</a></li><li><a href="classifai_should_register_save_post_handler.html">classifai_should_register_save_post_handler</a></li><li><a href="classifai_should_smart_crop_image.html">classifai_should_smart_crop_image</a></li><li><a href="classifai_smart_crop_max_pixel_dimension.html">classifai_smart_crop_max_pixel_dimension</a></li><li><a href="classifai_smart_crop_wp_filesystem.html">classifai_smart_crop_wp_filesystem</a></li><li><a href="classifai_smart_cropping_source_url.html">classifai_smart_cropping_source_url</a></li><li><a href="classifai_smart_cropping_thumb_file_name.html">classifai_smart_cropping_thumb_file_name</a></li><li><a href="classifai_taxonomy_for_feature.html">classifai_taxonomy_for_feature</a></li><li><a href="classifai_threshold.html">classifai_threshold</a></li><li><a href="classifai_whisper_transcribe_request_body.html">classifai_whisper_transcribe_request_body</a></li><li><a href="classifai_whisper_transcribe_result.html">classifai_whisper_transcribe_result</a></li><li><a href="classifai_%257B$this-_option_name%257D_enable_%257B$feature%257D.html">classifai_{$this->option_name}_enable_{$feature}</a></li><li><a href="%257B$this-_menu_slug%257D_providers.html">{$this->menu_slug}_providers</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-useful-snippets.html">Useful snippets</a></li><li><a href="tutorial-wp-cli.html">WP-CLI Commands</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
