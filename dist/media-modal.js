(()=>{"use strict";const e=Backbone.Model.extend({defaults:{url:""}}),t=wp.media.View.extend({el:".error",initialize:function(e){this.$el.text(""),this.render(e.error)},render:function(e){return this.$el.text(e),this}}),i=Backbone.Collection.extend({model:e,url:wpApiSettings.root+classifaiDalleData.endpoint,makeRequest:function(e){this.fetch({type:"get",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)},data:{prompt:e,format:"b64_json"},reset:!0,error:function(e,i){new t({error:i.responseJSON.message})}})}}),n=window.wp.mediaUtils,a=window.wp.url,r=wp.media.View.extend({tagName:"li",template:wp.template("dalle-image"),events:{"click .button-import":"import","click .button-import-insert":"importMediaLibrary","click .button-media-library":"loadMediaLibrary"},initialize:function(e){this.data=this.model.toJSON(),this.prompt=e.prompt,this.fileName=(0,a.cleanForSlug)(this.prompt)},render:function(){return this.$el.html(this.template(this.data)),this},import:async function(){var e;const t=this;this.enableLoadingState();const i=await this.convertImageToBlob(this.data.url);if(i)return await(0,n.uploadMedia)({filesList:[new File([i],this.fileName+".png")],onFileChange:function([e]){e&&e.id&&(t.file=e,t.$(".button-import").removeClass("button-import").addClass("button-media-library").text(classifaiDalleData.buttonText),t.$(".button-import-insert").remove(),t.disableLoadingState())},onError:function(e){t.disableLoadingState(),t.$(".error").text(e)},additionalData:{post:null!==(e=wp.media.model.settings.post.id)&&void 0!==e?e:0,caption:classifaiDalleData.caption,alt_text:this.prompt}});this.$(".error").text(classifaiDalleData.errorText)},importMediaLibrary:async function(){await this.import(),await this.loadMediaLibrary()},loadMediaLibrary:async function(){this.enableLoadingState();const e=wp.media.model.Attachment;this.attachment=await e.get(this.file.id).fetch();const t={file:this.attachment,uploading:!0,date:new Date,filename:this.fileName+".png",menuOrder:0,loaded:0,percent:0,uploadedTo:wp.media.model.settings.post.id},i=wp.media.model.Attachment.create(t);wp.Uploader.queue.add(i),_.each(["file","loaded","size","percent"],(function(e){i.unset(e)})),i.set(_.extend(this.attachment,{uploading:!1})),wp.media.model.Attachment.get(this.file.id,i),wp.Uploader.queue.reset(),this.disableLoadingState(),jQuery("#menu-item-browse").click()},enableLoadingState:function(){const e=this.$el.parent("ul").find("button"),t=this.$(".spinner");e.prop("disabled",!0),t.addClass("active")},disableLoadingState:function(){const e=this.$el.parent("ul").find("button"),t=this.$(".spinner");e.prop("disabled",!1),t.removeClass("active")},convertImageToBlob:async function(e){const t=new Image;t.src=`data:image/png;base64,${e}`,t.crossOrigin="anonymous",await this.loadImage(t);const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const n=i.getContext("2d");if(n)return n.drawImage(t,0,0),await new Promise((e=>{i.toBlob((t=>{t&&e(t)}),"image/jpeg")}))},loadImage:function(e){return new Promise((t=>e.onload=t))}}),o=wp.media.View.extend({el:".generated-images",initialize:function(e){this.collection=new i,this.prompt=e.prompt,this.listenTo(this.collection,"reset",this.renderAll),this.listenTo(this.collection,"error",this.error),this.collection.makeRequest(this.prompt),this.render()},render:function(){return this.$el.prev().find("button").prop("disabled",!0),this.$el.prev().find(".error").text(""),this.$("ul").empty(),this.$(".spinner").addClass("active"),this.$(".prompt-text").addClass("hidden"),this},renderImage:function(e){const t=new r({model:e,prompt:this.prompt});this.$("ul").append(t.render().el)},renderAll:function(){this.collection.length<1?(this.error(),this.$el.prev().find(".error").text(classifaiDalleData.errorText)):(this.$(".prompt-text").removeClass("hidden"),this.$(".prompt-text span").text(this.prompt),this.$(".spinner").removeClass("active"),this.collection.each(this.renderImage,this),this.$el.prev().find("button").prop("disabled",!1))},error:function(){this.$(".spinner").removeClass("active"),this.$el.prev().find("button").prop("disabled",!1)}}),s=wp.media.View.extend({template:wp.template("dalle-prompt"),events:{"click .button-generate":"promptRequest","keyup .prompt":"promptRequest"},render:function(){return this.$el.html(this.template()),this},promptRequest:function(e){let t="";13===e.which?t=e.target.value.trim():"BUTTON"===e.target.nodeName&&(t=e.target.parentElement.querySelector(".prompt").value.trim()),t&&new o({prompt:t})}}),l=wp.media.view.MediaFrame.Select,d=wp.media.view.MediaFrame.Post;wp.media.view.MediaFrame.Select=l.extend({bindHandlers:function(){l.prototype.bindHandlers.apply(this,arguments),this.on("content:render:generate",this.generateContent,this)},browseRouter:function(e){l.prototype.browseRouter.apply(this,arguments),e.set({generate:{text:classifaiDalleData.tabText,priority:30}})},generateContent:function(){this.content.set((new s).render())}}),wp.media.view.MediaFrame.Post=d.extend({bindHandlers:function(){d.prototype.bindHandlers.apply(this,arguments),this.on("content:render:generate",this.generateContent,this)},browseRouter:function(e){d.prototype.browseRouter.apply(this,arguments),e.set({generate:{text:classifaiDalleData.tabText,priority:30}})},generateContent:function(){this.content.set((new s).render())}})})();