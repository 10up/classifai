(()=>{"use strict";const e=window.wp.element,t=window.React;var s;function i(){return i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},i.apply(this,arguments)}var a=function(e){return t.createElement("svg",i({width:20,height:15,viewBox:"0 0 61 46",fill:"none",xmlns:"http://www.w3.org/2000/svg"},e),s||(s=t.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M3.52 0C1.575 0 0 1.584 0 3.538v38.924C0 44.416 1.576 46 3.52 46h53.96c1.944 0 3.52-1.584 3.52-3.538V3.538C61 1.584 59.424 0 57.48 0H3.52Zm13.189 8.138h4.739L33.58 39.554h-6.056l-3.492-9.04H13.97l-3.453 9.04h-5.96L16.709 8.138Zm2.38 8.563c-.104.34-.211.672-.319.997l-.012.036-2.76 7.406h6.148l-2.745-7.455-.312-.984Zm21.227-8.563h12.59v4.015l-3.413.819V34.63l3.413.779v4.024h-12.59V35.41l3.413-.78V12.972l-3.413-.818V8.138Z",fill:"#1e1e1e"})))};const o=window.wp.i18n,{get:n}=lodash,r=window.wp.data,c=window.wp.editPost,l=window.wp.components,d=window.wp.plugins,u={audioId:0,isProcessing:!1},p=(0,r.createReduxStore)("classifai-post-audio",{reducer(e=u,t){switch(t.type){case"SET_AUDIO_ID":return{...e,audioId:t.id};case"SET_PROCESSING_STATUS":return{...e,isProcessing:t.status}}return e},actions:{setAudioId:e=>({type:"SET_AUDIO_ID",id:e}),setIsProcessing:e=>({type:"SET_PROCESSING_STATUS",status:e})},selectors:{getAudioId:e=>e.audioId,getIsProcessing:e=>e.isProcessing}});(0,r.register)(p);const{classifaiEmbeddingData:g,classifaiPostData:f,classifaiTTSEnabled:_}=window,y=()=>(0,e.createElement)(l.Icon,{className:"components-panel__icon",icon:a,size:24}),m=()=>{const t=(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("classifai_process_content"))),{editPost:s}=(0,r.useDispatch)("core/editor"),i="no"===t?"no":"yes";return(0,e.createElement)(l.ToggleControl,{label:(0,o.__)("Process content on update","classifai"),help:"yes"===i?(0,o.__)("ClassifAI language processing is enabled","classifai"):(0,o.__)("ClassifAI language processing is disabled","classifai"),checked:"yes"===i,onChange:e=>{s({classifai_process_content:e?"yes":"no"})}})},P=async e=>{const{select:t,dispatch:s}=wp.data,i=t("core/editor").getCurrentPostId(),a=t("core/editor").getCurrentPostType(),n=t("core/editor").getPostTypeLabel()||(0,o.__)("Post","classifai");if(e&&e.terms){let r=!1;const c=Object.keys(e.terms),l={};if(c.forEach((s=>{let i=s;"post_tag"===s&&(i="tags"),"category"===s&&(i="categories");const a=[...t("core/editor").getEditedPostAttribute(s)||[],...e.terms[s].map((e=>Number.parseInt(e)))].filter(((e,t,s)=>s.indexOf(e)===t));a&&a.length&&(r=!0,l[i]=a)})),r){const e=await t("core/editor").isEditedPostDirty();await s("core").editEntityRecord("postType",a,i,l),e||await s("core").saveEditedEntityRecord("postType",a,i),s("core/notices").createSuccessNotice((0,o.sprintf)(/** translators: %s is post type label. */
(0,o.__)("%s classified successfully.","classifai"),n),{type:"snackbar"})}}},w=()=>{if("yes"==("no"===(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("classifai_process_content")))?"no":"yes"))return null;const t=wp.data.select("core/editor").getCurrentPostId(),s=wp.data.select("core/editor").getPostTypeLabel()||(0,o.__)("Post","classifai"),i=(0,o.sprintf)(/** translators: %s Post type label */
(0,o.__)("Classify %s","classifai"),s);return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(l.Button,{variant:"secondary","data-id":t,onClick:e=>(({button:e,endpoint:t,callback:s=!1,buttonText:i=(0,o.__)("Rescan","classifai")})=>{const a=e.getAttribute("data-id"),[r]=e.parentNode.getElementsByClassName("spinner"),[c]=e.parentNode.getElementsByClassName("error"),l=`${t}${a}`;e.setAttribute("disabled","disabled"),r.style.display="inline-block",r.classList.add("is-active"),c.style.display="none",wp.apiRequest({path:l}).then((t=>{e.removeAttribute("disabled"),r.style.display="none",r.classList.remove("is-active"),e.textContent=i,s&&s(t)}),(t=>{const s=n(t,"responseJSON",{code:"unknown_error",message:(0,o.__)("An unknown error occurred.","classifai")});r.style.display="none",r.classList.remove("is-active"),e.removeAttribute("disabled"),e.textContent=i,c.style.display="inline-block",c.textContent=`Error: ${s.message}`}))})({button:e.target,endpoint:"/classifai/v1/generate-tags/",callback:P,buttonText:i})},i),(0,e.createElement)("span",{className:"spinner",style:{display:"none",float:"none"}}),(0,e.createElement)("span",{className:"error",style:{display:"none",color:"#bc0b0b",padding:"5px"}}))},b=()=>{const[t,s]=(0,e.useState)(!1),[i,a]=(0,e.useState)((new Date).getTime()),n=(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("classifai_synthesize_speech"))),c=(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("classifai_display_generated_audio"))),d=(0,r.useSelect)((e=>void 0!==e("core/editor").getPostTypeLabel&&e("core/editor").getPostTypeLabel()||(0,o.__)("Post","classifai"))),u=(0,r.useSelect)((e=>e(p).getIsProcessing())),g=(0,r.useSelect)((e=>e("core/editor").getEditedPostAttribute("classifai_post_audio_id"))),f=(0,r.useSelect)((e=>e(p).getAudioId()))||g,_=(0,r.useSelect)((e=>e("core").getEntityRecords("postType","attachment",{include:[f]}))),y=_&&_.length>0&&_[0].source_url,m=(0,e.useRef)(!1),P=(0,e.useRef)(!1),{isSavingPost:w}=(0,r.useSelect)((e=>({isSavingPost:e("core/editor").isSavingPost()}))),{isAutosavingPost:b}=(0,r.useSelect)((e=>({isSavingPost:e("core/editor").isAutosavingPost()})));(0,e.useEffect)((()=>{const e=document.getElementById("classifai-audio-preview");e&&(t?e.play():e.pause())}),[t]),(0,e.useEffect)((()=>{u&&(m.current=!0),m.current&&!u&&a((new Date).getTime())}),[u]),(0,e.useEffect)((()=>{!w||b||P.current||(P.current=!0,n&&wp.data.dispatch(p).setIsProcessing(!0)),w||b||!P.current||(P.current=!1,wp.data.dispatch(p).setIsProcessing(!1))}),[w,b,n]);const E=`${y}?ver=${i}`;let h="controls-play";return u?h="format-audio":t&&(h="controls-pause"),(0,e.createElement)(e.Fragment,null,(0,e.createElement)(l.ToggleControl,{label:(0,o.__)("Enable audio generation","classifai"),help:(0,o.sprintf)(/** translators: %s is post type label. */
(0,o.__)("ClassifAI will generate audio for this %s when it is published or updated.","classifai"),d),checked:n,onChange:e=>{wp.data.dispatch("core/editor").editPost({classifai_synthesize_speech:e})},disabled:u,isBusy:u}),y&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)(l.ToggleControl,{label:(0,o.__)("Display audio controls","classifai"),help:(0,o.__)("Controls the display of the audio player on the front-end.","classifai"),checked:c,onChange:e=>{wp.data.dispatch("core/editor").editPost({classifai_display_generated_audio:e})},disabled:u,isBusy:u}),(0,e.createElement)(l.BaseControl,{id:"classifai-audio-preview-controls",help:u?"":(0,o.__)("Preview the generated audio.","classifai")},(0,e.createElement)(l.Button,{id:"classifai-audio-controls__preview-btn",icon:(0,e.createElement)(l.Icon,{icon:h}),variant:"secondary",onClick:()=>s(!t),disabled:u,isBusy:u},u?(0,o.__)("Generating audio..","classifai"):(0,o.__)("Preview","classifai")))),y&&(0,e.createElement)("audio",{id:"classifai-audio-preview",src:E,onEnded:()=>s(!1)}))};(0,d.registerPlugin)("classifai-plugin",{render:()=>{const t=(0,r.useSelect)((e=>e("core/editor").getCurrentPostType())),s=(0,r.useSelect)((e=>e("core/editor").getCurrentPostAttribute("status"))),i=f&&f.NLUEnabled,a=g&&g.enabled,n=f&&f.supportedPostTypes&&f.supportedPostTypes.includes(t),l=g&&g.supportedPostTypes&&g.supportedPostTypes.includes(t),d=f&&f.supportedPostStatues&&f.supportedPostStatues.includes(s),u=g&&g.supportedPostStatues&&g.supportedPostStatues.includes(s),p=f&&!(f.noPermissions&&1===parseInt(f.noPermissions))&&i&&n&&d,P=g&&!(g.noPermissions&&1===parseInt(g.noPermissions))&&a&&l&&u;return(0,e.createElement)(c.PluginDocumentSettingPanel,{title:(0,o.__)("ClassifAI","classifai"),icon:y,className:"classifai-panel"},(0,e.createElement)(e.Fragment,null,(p||P)&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)(m,null),p&&(0,e.createElement)(w,null)),_&&(0,e.createElement)(b,null)))}})})();