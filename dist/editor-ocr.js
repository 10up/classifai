(()=>{"use strict";const e=window.React,t=window.wp.data,c=window.wp.blocks,n=window.wp.apiFetch,o=window.wp.hooks,i=window.wp.compose,r=window.wp.blockEditor,a=window.wp.components,l=window.wp.i18n,s=window.wp.element,{find:d,debounce:p}=lodash,m=(0,e.createElement)("span",{className:"dashicons dashicons-editor-paste-text"}),u=async(e,n,o)=>{if(!o)return;const{getBlockIndex:i}=(0,t.select)("core/block-editor"),r=(0,c.createBlock)("core/group",{anchor:`classifai-ocr-${n}`,className:"is-style-classifai-ocr-text"}),a=(0,c.createBlock)("core/paragraph",{content:o});await(0,t.dispatch)("core/block-editor").insertBlock(r,i(e)+1),(0,t.dispatch)("core/block-editor").insertBlock(a,0,r.clientId)},f=(e,c=[])=>{if(0===c.length){const{getBlocks:e}=(0,t.select)("core/block-editor");c=e()}return!!d(c,(t=>t.attributes.anchor===`classifai-ocr-${e}`))},b=(0,i.createHigherOrderComponent)((t=>c=>{const[o,i]=(0,s.useState)(!1),{attributes:d,clientId:p,isSelected:b,name:h,setAttributes:g}=c;return b&&"core/image"==h?(!d.ocrChecked&&d.id&&(async e=>{const t=await(0,n.apiFetch)({path:`/wp/v2/media/${e}`});return!(!Object.prototype.hasOwnProperty.call(t,"classifai_has_ocr")||!t.classifai_has_ocr)&&!!(Object.prototype.hasOwnProperty.call(t,"description")&&Object.prototype.hasOwnProperty.call(t.description,"rendered")&&t.description.rendered)&&t.description.rendered.replace(/(<([^>]+)>)/gi,"").replace(/(\r\n|\n|\r)/gm,"").trim()})(d.id).then((e=>{e?(g({ocrScannedText:e,ocrChecked:!0}),i(!0)):g({ocrChecked:!0})})),(0,e.createElement)(s.Fragment,null,(0,e.createElement)(t,{...c}),d.ocrScannedText&&(0,e.createElement)(r.BlockControls,null,(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{label:(0,l.__)("Insert scanned text into content","classifai"),icon:m,onClick:()=>u(p,d.id,d.ocrScannedText),disabled:f(d.id)}))),o&&(0,e.createElement)(a.Modal,{title:(0,l.__)("ClassifAI detected text in your image","classifai")},(0,e.createElement)("p",null,(0,l.__)("Would you like to insert the scanned text under this image block? This enhances search indexing and accessibility for your readers.","classifai")),(0,e.createElement)(a.Flex,{align:"flex-end",justify:"flex-end"},(0,e.createElement)(a.FlexItem,null,(0,e.createElement)(a.Button,{isPrimary:!0,onClick:()=>{u(p,d.id,d.ocrScannedText),i(!1)}},(0,l.__)("Insert text","classifai"))),(0,e.createElement)(a.FlexItem,null,(0,e.createElement)(a.Button,{isSecondary:!0,onClick:()=>i(!1)},(0,l.__)("Dismiss","classifai"))))))):(0,e.createElement)(t,{...c})}),"imageOcrControl");(0,o.addFilter)("editor.BlockEdit","classifai/image-processing-ocr",b),(0,o.addFilter)("blocks.registerBlockType","classifai/image-processing-ocr",((e,t)=>("core/image"!==t||e.attributes&&(e.attributes.ocrScannedText={type:"string",default:""},e.attributes.ocrChecked={type:"boolean",default:!1}),e))),wp.blocks.registerBlockStyle("core/group",{name:"classifai-ocr-text",label:(0,l.__)("Scanned Text from Image","classifai")});{let e,c=[];(0,t.subscribe)(p((()=>{const n=(0,t.select)("core/block-editor"),r=n.getSelectedBlock(),a=n.getBlocks();if(null===r)return i(),void(e=r);if(r!==e&&!c.includes(r.clientId))if(i(),e=r,"core/image"===r.name){const e=d(a,(e=>e.attributes.anchor===`classifai-ocr-${r.attributes.id}`));void 0!==e&&o([e.clientId,r.clientId])}else{const e=n.getBlock(n.getBlockHierarchyRootClientId(r.clientId));if("core/group"===e.name){let t=/classifai-ocr-([0-9]+)/.exec(e.attributes.anchor);if(null!==t){[,t]=t;const c=d(a,(e=>e.attributes.id==t));void 0!==c&&o([c.clientId,e.clientId])}}}}),100));const n=()=>{const e=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style");return t.setAttribute("id","classifai-ocr-style"),e.appendChild(t),t},o=e=>{var t;const o=null!==(t=document.getElementById("classifai-ocr-style"))&&void 0!==t?t:n(),i=`${e.map((e=>`#block-${e}:before`)).join(", ")} {\n\t\t\tcontent: "";\n\t\t\tposition: absolute;\n\t\t\tdisplay: block;\n\t\t\ttop: 0;\n\t\t\tleft: -15px;\n\t\t\tbottom: 0;\n\t\t\tborder-left: 4px solid #cfe7f3;\n\t\t\tmix-blend-mode: difference;\n\t\t\topacity: 0.25;\n\t\t}`;o.appendChild(document.createTextNode(i)),c=e},i=()=>{if(0===c.length)return;const e=document.getElementById("classifai-ocr-style");e&&(e.innerText=""),c=[]}}})();